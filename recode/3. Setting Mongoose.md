# 3. Setting Mongoose

2022-09-05

## MongoDB ì—°ê²°ì„ ìœ„í•œ ì¤€ë¹„

1. í”„ë¡œì íŠ¸ì— Mongoose ì„¤ì¹˜ (npm install mongoose â€”save)

## MongoDB Project ìƒì„±í•˜ê¸°

1. MongoDB Project ìƒì„±
2. MongoDB cluster ìƒì„± (sharedê°€ ë¬´ë£Œ)
3. MongoDB ì£¼ì†Œ ì•Œì•„ë‚´ê¸°
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/e63d6b35-78f7-4db2-ac83-480d5c62ffc1/Untitled.png)
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/44f90c15-169c-47d7-b899-5565a5987543/Untitled.png)
    
4. ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ì— schemas í´ë” ìƒì„±
5. schemas í´ë” ì•ˆì— index.js íŒŒì¼ ìƒì„± í›„ ì•„ë˜ì˜ ì½”ë“œ ì‘ì„±

```jsx
const mongoose = require('mongoose');

module.exports = () => {
    const connect = () => {

        //1. ê°œë°œ í™˜ê²½ì´ ì•„ë‹ ë•Œ ëª½êµ¬ìŠ¤ê°€ ìƒì„±í•˜ëŠ” ì¿¼ë¦¬ ë‚´ìš©ì„ ì½˜ì†”ì„ í†µí•´ í™•ì¸í•  ìˆ˜ ìˆëŠ” ë¶€ë¶„
        if(process.env.NODE_ENV !== 'production') {
            mongoose.set('debug', true);
        }

        //2. ëª½êµ¬ìŠ¤ì™€ ëª½ê³ ë””ë¹„ë¥¼ ì—°ê²°í•˜ëŠ” ë¶€ë¶„ìœ¼ë¡œ ëª½ê³ ë””ë¹„ ì£¼ì†Œë¡œ ì ‘ì†ì„ ì‹œë„í•œë‹¤.
        mongoose.connect("mongodb+srv://moon:1234@cluster0.k8htexd.mongodb.net/test", { 
            useNewUrlParser: true, useUnifiedTopology: true})
            .then(() => console.log('ëª½ê³ ë””ë¹„ ì—°ê²° ì„±ê³µ'))
            .catch(e => console.error('ëª½ê³ ë””ë¹„ ì—°ê²° ì—ëŸ¬', e));

        //3. ëª½êµ¬ìŠ¤ ì»¤ë‚µì…˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ. ì—ëŸ¬ ë°œìƒ ì‹œ ì—ëŸ¬ ë‚´ìš©ì„ ê¸°ë¡í•˜ê³ , ì—°ê²° ì¢…ë£Œ ì‹œ ì¬ì—°ê²°ì„ ì‹œë„í•œë‹¤.
        mongoose.connection.on('error', (error) => {
            console.error('ëª½ê³ ë””ë¹„ ì—°ê²° ì—ëŸ¬', error);
        });

        mongoose.connection.on('disconnected', () => {
            console.error('ëª½ê³ ë””ë¹„ ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤. ì¬ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤.');
            connect();
        });

        //4. User ìŠ¤í‚¤ë§ˆì™€ Comment ìŠ¤í‚¤ë§ˆë¥¼ ì—°ê²°í•˜ëŠ” ë¶€ë¶„
        require('./user');
        require('./comment');
    }
}
```

1. schemas/index.jsë¥¼ app.jsì™€ ì—°ê²°í•˜ì—¬ ë…¸ë“œ ì‹¤í–‰ ì‹œ mongoose.connectë¶€ë¶„ë„ ì‹¤í–‰í•˜ê²Œ í•¨

```jsx
//mongoose connect
var connect = require('./schemas');

var app = express();
connect();
```

1. ìŠ¤í‚¤ë§ˆ ì •ì˜í•˜ê¸°
    1. User ìŠ¤í‚¤ë§ˆ
    
    ```jsx
    const mongoose = require('mongoose');
    
    const { Schema } = mongoose;
    const userSchema = new Schema({
        name: {
            type: String,
            required: true,
            unique: true,
        },
        age: {
            type: Number,
            required: true,
        },
        married: {
            type: Boolean,
            required: true,
        },
        comment: String,
        createAt: {
            type: Date,
            default: Date.now,
        },
    });
    
    module.exports = mongoose.model('User', userSchema);
    ```
    
    - ëª½êµ¬ìŠ¤ ëª¨ë“ˆì—ì„œ Schema ìƒì„±ìë¥¼ ì‚¬ìš©í•´ ìŠ¤í‚¤ë§ˆë¥¼ ë§Œë“¤ê³  í•„ë“œë¥¼ ê°ê° ì •ì˜í•œë‹¤.
    - ë§ˆì§€ë§‰ì— ëª½êµ¬ìŠ¤ì˜ model ë©”ì„œë“œë¡œ ìŠ¤í‚¤ë§ˆì™€ ëª½ê³ ë””ë¹„ ì»¬ë ‰ì…˜ì„ ì—°ê²°í•˜ëŠ” ëª¨ë¸ì„ ë§Œë“ ë‹¤.
    
     b. Comment ìŠ¤í‚¤ë§ˆ
    
    ```jsx
    const mongoose = require('mongoose');
    
    const { Schema } = mongoose;
    const commentSchema = new Schema({
        commenter: {
            type: ObjectId,
            required: true,
            ref: 'User',
        },
        comment: {
            type: String,
            required: true,
        },
        createAt: {
            type: Date,
            default: Date.now,
        },
    });
    
    module.exports = mongoose.model('Comment', commentSchema);
    ```
    

## ì¿¼ë¦¬ ìˆ˜í–‰í•˜ê¸°

1. views í´ë” ì•ˆì— mongoose.html íŒŒì¼ì„ ë§Œë“¤ì–´ ì„ì˜ì˜ í”„ë¡ íŠ¸ ì½”ë“œë¥¼ ì…ë ¥í•œë‹¤.

```jsx
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>ëª½êµ¬ìŠ¤ ì„œë²„</title>
    <style>
      table { border: 1px solid black; border-collapse: collapse; }
      table th, table td { border: 1px solid black; }
    </style>
  </head>
  <body>
    <div>
      <form id="user-form">
        <fieldset>
          <legend>ì‚¬ìš©ì ë“±ë¡</legend>
          <div><input id="username" type="text" placeholder="ì´ë¦„"></div>
          <div><input id="age" type="number" placeholder="ë‚˜ì´"></div>
          <div><input id="married" type="checkbox"><label for="married">ê²°í˜¼ ì—¬ë¶€</label></div>
          <button type="submit">ë“±ë¡</button>
        </fieldset>
      </form>
    </div>
    <br>
    <table id="user-list">
      <thead>
      <tr>
        <th>ì•„ì´ë””</th>
        <th>ì´ë¦„</th>
        <th>ë‚˜ì´</th>
        <th>ê²°í˜¼ì—¬ë¶€</th>
      </tr>
      </thead>
      <tbody>
      {% for user in users %}
      <tr>
        <td>{{user.id}}</td>
        <td>{{user.name}}</td>
        <td>{{user.age}}</td>
        <td>{{ 'ê¸°í˜¼' if user.married else 'ë¯¸í˜¼'}}</td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
    <br>
    <div>
      <form id="comment-form">
        <fieldset>
          <legend>ëŒ“ê¸€ ë“±ë¡</legend>
          <div><input id="userid" type="text" placeholder="ì‚¬ìš©ì ì•„ì´ë””"></div>
          <div><input id="comment" type="text" placeholder="ëŒ“ê¸€"></div>
          <button type="submit">ë“±ë¡</button>
        </fieldset>
      </form>
    </div>
    <br>
    <table id="comment-list">
      <thead>
      <tr>
        <th>ì•„ì´ë””</th>
        <th>ì‘ì„±ì</th>
        <th>ëŒ“ê¸€</th>
        <th>ìˆ˜ì •</th>
        <th>ì‚­ì œ</th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="/mongoose.js"></script>
  </body>
</html>
```

1. public í´ë” ì•ˆì— ì„ì˜ì˜ js íŒŒì¼ì¸ mongoose.js íŒŒì¼ì„ ë§Œë“ ë‹¤.

```jsx
// ì‚¬ìš©ì ì´ë¦„ ëˆŒë €ì„ ë•Œ ëŒ“ê¸€ ë¡œë”©
document.querySelectorAll('#user-list tr').forEach((el) => {
  el.addEventListener('click', function () {
    const id = el.querySelector('td').textContent;
    getComment(id);
  });
});
// ì‚¬ìš©ì ë¡œë”©
async function getUser() {
  try {
    const res = await axios.get('/users');
    const users = res.data;
    console.log(users);
    const tbody = document.querySelector('#user-list tbody');
    tbody.innerHTML = '';
    users.map(function (user) {
      const row = document.createElement('tr');
      row.addEventListener('click', () => {
        getComment(user._id);
      });
      // ë¡œìš° ì…€ ì¶”ê°€
      let td = document.createElement('td');
      td.textContent = user._id;
      row.appendChild(td);
      td = document.createElement('td');
      td.textContent = user.name;
      row.appendChild(td);
      td = document.createElement('td');
      td.textContent = user.age;
      row.appendChild(td);
      td = document.createElement('td');
      td.textContent = user.married ? 'ê¸°í˜¼' : 'ë¯¸í˜¼';
      row.appendChild(td);
      tbody.appendChild(row);
    });
  } catch (err) {
    console.error(err);
  }
}
// ëŒ“ê¸€ ë¡œë”©
async function getComment(id) {
  try {
    const res = await axios.get(`/users/${id}/comments`);
    const comments = res.data;
    const tbody = document.querySelector('#comment-list tbody');
    tbody.innerHTML = '';
    comments.map(function (comment) {
      // ë¡œìš° ì…€ ì¶”ê°€
      const row = document.createElement('tr');
      let td = document.createElement('td');
      td.textContent = comment._id;
      row.appendChild(td);
      td = document.createElement('td');
      td.textContent = comment.commenter.name;
      row.appendChild(td);
      td = document.createElement('td');
      td.textContent = comment.comment;
      row.appendChild(td);
      const edit = document.createElement('button');
      edit.textContent = 'ìˆ˜ì •';
      edit.addEventListener('click', async () => { // ìˆ˜ì • í´ë¦­ ì‹œ
        const newComment = prompt('ë°”ê¿€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
        if (!newComment) {
          return alert('ë‚´ìš©ì„ ë°˜ë“œì‹œ ì…ë ¥í•˜ì…”ì•¼ í•©ë‹ˆë‹¤');
        }
        try {
          await axios.patch(`/comments/${comment._id}`, { comment: newComment });
          getComment(id);
        } catch (err) {
          console.error(err);
        }
      });
      const remove = document.createElement('button');
      remove.textContent = 'ì‚­ì œ';
      remove.addEventListener('click', async () => { // ì‚­ì œ í´ë¦­ ì‹œ
        try {
          await axios.delete(`/comments/${comment._id}`);
          getComment(id);
        } catch (err) {
          console.error(err);
        }
      });
      // ë²„íŠ¼ ì¶”ê°€
      td = document.createElement('td');
      td.appendChild(edit);
      row.appendChild(td);
      td = document.createElement('td');
      td.appendChild(remove);
      row.appendChild(td);
      tbody.appendChild(row);
    });
  } catch (err) {
    console.error(err);
  }
}
// ì‚¬ìš©ì ë“±ë¡ ì‹œ
document.getElementById('user-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = e.target.username.value;
  const age = e.target.age.value;
  const married = e.target.married.checked;
  if (!name) {
    return alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
  }
  if (!age) {
    return alert('ë‚˜ì´ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
  }
  try {
    await axios.post('/users', { name, age, married });
    getUser();
  } catch (err) {
    console.error(err);
  }
  e.target.username.value = '';
  e.target.age.value = '';
  e.target.married.checked = false;
});
// ëŒ“ê¸€ ë“±ë¡ ì‹œ
document.getElementById('comment-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = e.target.userid.value;
  const comment = e.target.comment.value;
  if (!id) {
    return alert('ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
  }
  if (!comment) {
    return alert('ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”');
  }
  try {
    await axios.post('/comments', { id, comment });
    getComment(id);
  } catch (err) {
    console.error(err);
  }
  e.target.userid.value = '';
  e.target.comment.value = '';
});
```

â†’ script íƒœí¬ì—ëŠ” ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì„œë²„ì˜ ë¼ìš°í„°ë¡œ AJAX ìš”ì²­ì„ ë³´ë‚´ëŠ” ì½”ë“œê°€ ë“¤ì–´ìˆë‹¤.

## ë¼ìš°í„° ì‘ì„±í•˜ê¸°

1. index.js

```jsx
const { application } = require('express');
var express = require('express');
var router = express.Router();
//ìŠ¤í‚¤ë§ˆ ê°€ì ¸ì˜¤ê¸°
var User = require('../schemas/user');

//ë¶„ë¦¬í•œ ë¼ìš°í„° ì£¼ì†Œ
var usersRouter = require('./users');
var signinRouter = require('./signin');//ë¡œê·¸ì¸
var signupRouter = require('./signup');//íšŒì›ê°€ì…

var app = express();

//ë¶„ë¦¬í•œ ë¼ìš°í„° ì—°ê²°
app.use('/users', usersRouter); //ë¡œê·¸ì¸
app.use('/signin', signinRouter); //ë¡œê·¸ì¸
app.use('/signup', signupRouter); //íšŒì›ê°€ì…

//í”„ë¡œë¯¸ìŠ¤ í˜•ì‹ -> async/await í˜•ì‹
router.get('/', async(req, res, next) {
  try {
    const users = await User.find();
    //ëª¨ë“  ì‚¬ìš©ìë¥¼ ì°¾ìŒ. User ìŠ¤í‚¤ë§ˆë¥¼ require í•œ ë’¤ find ì‚¬ìš© ê°€ëŠ¥
    res.render('mongoose', { users });
    //ë Œë”ë§í•  ë•Œ usersë¥¼ ë³€ìˆ˜ë¡œ ë„£ì–´ì¤Œ
  }
  catch(err) {
    console.error(err);
    next(err);
  }
});

module.exports = router;
```

<aside>
ğŸ”¥ async/await ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°

</aside>

1. routers/users.js

```jsx
const express = require('express');
const User = require('../schemas/user');
const Comment = require('../schemas/comment');

const router = express.Router();

router.route('/')
//ì‚¬ìš©ìë¥¼ ì¡°íšŒí•˜ëŠ” ìš”ì²­
  .get(async (req, res, next) => {
    try {
      //ì‚¬ìš©ì ë°ì´í„° ì „ì²´ ì¡°íšŒ
      const users = await User.find({});
      //jsoní˜•ì‹ìœ¼ë¡œ ë°˜í™˜
      res.json(users);
    } catch (err) {
      console.error(err);
      next(err);
    }
  })
//ì‚¬ìš©ìë¥¼ ë“±ë¡í•˜ëŠ” ìš”ì²­
  .post(async (req, res, next) => {
    try {
      //ì‚¬ìš©ìë¥¼ ë“±ë¡í•˜ëŠ” ê³¼ì •
      //1. ëª¨ë¸ë¡œ user ê°ì²´ë¥¼ ë§Œë“¤ê³  
      const user = await User.create({
        //2. ê°ì²´ ì•ˆì— ë‹¤íë¨¼íŠ¸ ì•ˆì— ë“¤ì–´ê°ˆ ë‚´ìš©ë“¤ì„ ë„£ì–´ì¤€ë‹¤.
        name: req.body.name,
        age: req.body.age,
        married: req.body.married,
      });
      //3. save ë©”ì„œë“œë¡œ ì €ì¥. ì •ì˜í•œ ìŠ¤í‚¤ë§ˆì— ë¶€í•©í•˜ì§€ ì•ŠëŠ” ë°ì´í„°ë¥¼ ë„£ì—ˆì„ ë•ŒëŠ” ëª½êµ¬ìŠ¤ê°€ ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¨ë‹¤.
      console.log(user);
      res.status(201).json(user);
    } catch (err) {
      console.error(err);
      next(err);
    }
  });

router.get('/:id/comments', async (req, res, next) => {
  try {
    const comments = await Comment.find({ commenter: req.params.id })
      .populate('commenter');
    console.log(comments);
    res.json(comments);
  } catch (err) {
    console.error(err);
    next(err);
  }
});

module.exports = router;
```

1. routers/comment.js

```jsx
const express = require('express');
const Comment = require('../schemas/comment');

const router = express.Router();

//ë‹¤íë¨¼íŠ¸ë¥¼ ë“±ë¡í•˜ëŠ” ë¼ìš°í„°
router.post('/', async (req, res, next) => {
  try {
     //1. Comment ìŠ¤í‚¤ë§ˆë¡œ comment ê°ì²´ë¥¼ ë§Œë“¤ì–´
    const comment = await Comment.create({
        //2. ì•ˆì— ë‹¤íë¨¼íŠ¸ ë‚´ìš©ì„ ë„£ì€ ë’¤
      commenter: req.body.id,
      comment: req.body.comment,
    });
    console.log(comment);
    //4. ê²°ê³¼ë¡œ ë°˜í™˜ëœ resultê°ì²´ë¥¼ populate ë©”ì„œë“œë¥¼ commenter ìŠ¤í‚¤ë§ˆì™€ í•©ì¹¨(path ì˜µì…˜ìœ¼ë¡œ ì–´ë–¤ í•„ë“œë¥¼ í•©ì¹ ì§€ ì„¤ì •í•˜ëŠ” ë°©ë²•)
    const result = await Comment.populate(comment, { path: 'commenter' });
    //3. save ë©”ì„œë“œë¡œ ì €ì¥
    res.status(201).json(result);
  } catch (err) {
    console.error(err);
    next(err);
  }
});

router.route('/:id')
    //ë‹¤íë¨¼íŠ¸ë¥¼ ìˆ˜ì •í•˜ëŠ” ë¼ìš°í„°
  .patch(async (req, res, next) => {
    try {
        //1. update ë©”ì„œë“œë¡œ ìˆ˜ì •
      const result = await Comment.update({
        //2. ì–´ë–¤ ë‹¤íë¨¼íŠ¸ë¥¼ ìˆ˜ì •í• ì§€ì— ëŒ€í•œ ì¿¼ë¦¬ ê°ì²´
        _id: req.params.id,
      }, {
        //3. ìˆ˜ì •í•  í•„ë“œì™€ ê°’ì´ ë“¤ì–´ ìˆëŠ” ê°ì²´ë¥¼ ì œê³µ
        comment: req.body.comment,
      });
      res.json(result);
    } catch (err) {
      console.error(err);
      next(err);
    }
  })

  //ë‹¤íë¨¼íŠ¸ë¥¼ ì‚­ì œí•˜ëŠ” ë¼ìš°í„°
  .delete(async (req, res, next) => {
    try {
        //1. remove ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚­ì œ
      const result = await Comment.remove({ _id: req.params.id });
      res.json(result);
    } catch (err) {
      console.error(err);
      next(err);
    }
  });

module.exports = router;
```

## ë¼ìš°í„° ì„œë²„ì— ì—°ê²°í•˜ê³  ì‹¤í–‰ í…ŒìŠ¤íŠ¸í•˜ê¸°

1. app.js